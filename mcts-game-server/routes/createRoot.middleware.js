'use strict';
{
	var _ = require('lodash')
		, boards = require('../lib/boards')
		, knowledgeBase = require('../database')
		, debug = require('debug')('mcts:routes:createRoot')

	module.exports = function(req, res, next) {
		var variantName = _.get(req.params, 'variant')
			, hasVariant = boards.hasVariant(variantName);
		if (!hasVariant) {
			res.status(400);
			next('[game.middleware] Error: ' + variant + ' is not a valid game variant');
		} else {
			var variant = boards[variantName]
				, rootNodeData = variant.rootNodeData();
			debug('calling configureDatabase() to first apply database settings')
			knowledgeBase.configureDatabase()
				.then(function(configured) {
					res.locals.configured = configured;  // nothing for now
					debug('calling createNewRoot() with the root board data generated by the ' + variantName + ' variant file in gameVariant/' + variantName + '.js')
					knowledgeBase.createNewRoot(rootNodeData.board, rootNodeData.moves)
						.then(function(result) {
							res.locals = result;
							next();
						})
						.catch(function(err) {
							next(err)
						})
				})
				.catch(function(err) {
					next(err);
				})
		}
	}
}